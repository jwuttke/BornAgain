%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain Physics Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015-2020
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\hu{{\v{\hat u}}}
\def\ka{{\k\alpha}}
\def\TD{\v{D}}
\def\Td{\v{\delta}}
\def\TG{\v{G}}
\def\TU{\v{U}}
\def\TV{\v{V}}
\def\TL{\v{\Lambda}}
\def\TDo{\v{D}_0}%\overset{o}{D}}}
\def\TGo{\v{G}_0}%{\overset{o}{G}}}
\def\TGoa{\v{G}_{0\alpha}}%{\overset{o}{G}}}
\def\vGo{\TGo} %{\v{\overset{o}{G}}\vphantom{\v{G}}}
\def\TR{\v{R}}
\def\PauliVec{\v{\sigma}}
\def\Psio{\v{\Psi}_0}%\v{\overset{o}{\Psi}}\vphantom{\Psi}}
\def\Psioa{\v{\Psi}_{0\alpha}}\
\def\ue{\v{\hat u}}

\def\pfo{\overset{o}{\psi}_\sf}
\def\pfoc{\overset{o}{\psi}\vphantom{\psi}^*_\sf}
\def\Cdot{\v{\cdot}}

\chapter{Scattering}\label{SSca}%
\chaptermark{Scattering}%
\index{Elastic scattering|seealso{Cross section}}%

This chapter provides a self-contained introduction
into the theory of neutron and X-ray scattering,
as needed for the analysis of grazing-incidence small-angle scattering (GISAS) experiments.
\index{Grazing-incidence small-angle scattering}%
\index{Scattering!grazing incidence|see{Grazing-incidence small-angle scattering}}%
\index{GISAS|see{Grazing-incidence small-angle scattering}}%
In \Cref{Swave},
a generic wave equation is derived.
In \Cref{SDWBA},
it is solved in first-order distorted-wave Born approximation (DWBA).
\index{DWBA|see {Distorted-wave Born approximation}}%
\index{Distorted-wave Born approximation}%
The chapter finishes with a qualitative discussion
of coherence lengths in \Cref{Scoherlen}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wave propagation}\label{Swave}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Wave propagation|(}%

In this section, we review the wave equations that describe the propagation
of neutrons (\cref{SnScalar,SnSpinor}) and X-rays (\cref{SXwave}) in matter,
and combine them into a unified wave equation (\cref{SuniWave})
that is the base for the all following analysis.
This provides justification and background
for Eqns.~1--3 in the BornAgain reference paper~\cite{PoHB20}.

%===============================================================================
\subsection{Neutrons in a scalar potential}\label{SnScalar}
%===============================================================================
\index{Wave propagation!neutron|(}%
\index{Neutron!wave propagation|(}%

\def\Vmac{\tilde{V}}

\index{Wavefunction!scalar}
The scalar wavefunction $\psi(\r,t)$
\nomenclature[2t020]{$t$}{Time}%
\nomenclature[2r040]{$\r$}{Position}%
\nomenclature[1ψ030 2r040 2t02]{$\psi(\r,t)$}{Microscopic neutron wavefunction}%
of a free neutron
in absence of a magnetic field
is governed by the Schrödinger equation
\index{Schrodinger@Schrödinger equation}%
\begin{equation}\label{ESchrodi1}
  i\hbar\partial_t \psi(\r,t)
  = \left[-\frac{\hbar^2}{2m}\Nabla^2+V(\r)\right] \psi(\r,t).
\end{equation}
BornAgain concentrates on elastic scattering;
\index{Scattering!elastic}%
inelastic scattering is either neglected,
\index{Scattering!inelastic}%
or accounted for by some extra damping as discussed at the end of this subsection.
\index{Damping!inelastic scattering}%
Therefore, any time dependence of the potential
\index{Potential!neutron}%
\index{Neutron!potential}%
$V(\r)\coloneqq \langle V(\r,t)\rangle$
\nomenclature[2v130 2r040]{$V(\r)$}{Neutron potential}%
 is averaged out,
and only monochromatic waves
with given frequency~$\omega$ are considered.
\index{Frequency!neutron wavefunction}%
\nomenclature[1ω 020]{$\omega$}{Frequency of incident radiation}%
In consequence, the wavefunction
\begin{equation}\label{Estationarywave}
  \psi(\r,t) = \psi(\r)\e^{-i\omega t}
\end{equation}
\nomenclature[1ψ030 2r040 0]{$\psi(\r)$}{Stationary wavefunction}%
factorizes into a stationary wave and a time-dependent phase factor.
\index{Phase factor}%
In the following, we will characterize the incoming radiation
not by its energy~$\hbar\omega$,
but by its \E{vacuum wavenumber}~$K$,
\index{Wavenumber!neutron}%
\nomenclature[2k120]{$K$}{Wavenumber in vacuum}%
given by the dispersion relation
\index{Dispersion relation!neutron}%
\begin{equation}
  \hbar\omega = \frac{(\hbar K)^2}{2m}.
\end{equation}
We rescale the potential as
\begin{equation}\label{EvScale}
  v(\r)
  \coloneqq \frac{2m}{\hbar^2} V(\r).
\end{equation}
This deviates by a factor~$4\pi$ from our previous choice in~\cite{PoHB20}.
The Schrödinger equation~\cref{ESchrodi1} now takes the simple form
\index{Schrodinger@Schrödinger equation}%
\begin{equation}\label{ESchrodi2}
  \left[\Nabla^2+K^2-v(\r)\right] \psi(\r) = 0.
\end{equation}
The microscopic expression for~$v(\r)$ is based on Fermi's pseudopotential,
\index{Fermi's pseudopotential}%
\index{Pseudopotential}%
\index{Potential!neutron}%
\index{Neutron!pseudopotential}%
\begin{equation}\label{EvFermi}
  v(\r)
  = 4\pi\sum_j\left\langle b_j \delta\left(\r-\r_j(t)\right)\right\rangle.
\end{equation}
The sum runs over all nuclei in the scattering target.
The \E{bound scattering length}~$b_j$
\index{Scattering length}%
\index{Bound scattering length|see{Scattering length}}%
\nomenclature[2b0]{$b$}{Bound scattering length}%
is isotope specific;
\index{Isotope}%
values are tabulated \cite{Sea92}.

In small-angle scattering,
\index{Scattering!small-angle}%
\index{Small-angle scattering}%
\index{SAS|see{Small-angle scattering}}%
as elsewhere in neutron optics \cite{Sea89},
\index{Neutron!optics}%
\index{Optics!neutron}%
the potential \cref{EvFermi}
can be coarse-grained by spatially averaging over at least a few atomic diameters,
yielding the \E{scattering length density} (SLD)
\index{Scattering length density}%
\index{SLD|see{Scattering length density}}%
\cite[eq.\ 2.8.37]{Sea89}.
\begin{equation}\label{Evrcoarse}
  v(\r)
  = \sum_s b_s \rho_s(\r).
\end{equation}
\nomenclature[2v030 2r040]{$v(\r)$}{Rescaled neutron potential, scattering length density (SLD)}%
Here the sum runs over chemical elements,
$b_s\coloneqq\langle b_j\rangle_{j\in s}$ is the bound \E{coherent} scattering length,
\index{Coherent scattering length}%
\index{Scattering length!coherent}%
and $\rho_s$ is a number density.
\index{Number density}%
\index{Density}%
\nomenclature[1ρ032 2s010]{$\rho_s$}{Number density of chemical element~$s$}%

In passing from \cref{EvFermi} to \cref{Evrcoarse},
we neglected Bragg scattering
\index{Scattering!Bragg}%
\index{Bragg scattering}%
from atomic-scale correlation,
\index{Atomic scale}%
\index{Correlation!atomic scale}%
and incoherent scattering from spin or isotope related fluctuations of $b_j$.
\index{Scattering!incoherent}%
\index{Isotope}%
\index{Spin!neutron}%
\index{Neutron!spin}%
In small-angle experiments,
 incoherent scattering only contributes a diffuse background.
Furthermore, it is possible
that it causes a noticeable attenuation of the incoming or scattered radiation.
Other loss channels are elastic wide-angle scattering
\index{Loss channels}
\index{Scattering!wide-angle}%
and inelastic scattering.
\index{Scattering!inelastic}%
They can all be lumped into an ad-hoc increment of the
imaginary part of the refractive index,
\index{Refractive index!loss terms}%
which otherwise, at the microscopic level~\cref{EvFermi},
accounts for absorption
\index{Absorption}
only.
Furthermore, incoherent scattering, as inelastic scattering,
 contributes to the diffuse background in the detector.
\index{Scattering!diffuse}%
\index{Inelastic scattering}%
\index{Background!diffuse}%
\index{Detector!background}%

%===============================================================================
\subsection{Neutrons in a magnetic field}\label{SnSpinor}
%===============================================================================

\index{Neutron!spin|(}%
\index{Spin|(}%
\index{Magnetic field!neutron propagation|(}%

\index{Field!magnetic|see{Magnetic field}}%
\index{H Field@$H$ Field|see{Magnetizing field}}%
\index{B Field@$B$ Field|see{Magnetic field}}%

In the presence of a magnetic field,
the propagation of free neutrons becomes spin dependent.
Therefore the scalar wavefunction of \cref{SnScalar}
must be replaced by a spinor $\v\Psi$.
\index{Spinor}%
The magnetic moment $\v{\mu}$ of the neutron
\nomenclature[1μ024 2n000]{$\mu$}{Absolute value of the magnetic moment of the neutron,
  $1.91\mu_\text{N}$}
\index{Neutron!magnetic moment}%
\index{Magnetic moment!neutron}%
couples to the magnetic induction~$\v{B}$ \cite{Sea89,Mez86,MaOB06}.
\nomenclature[2h150 2r040 2t020]{$\v{B}(\r,t)$}{Magnetic induction}%
\index{Magnetizing field!coupling to neutron moment}%
With the Pauli vector $\PauliVec$, composed of the three Pauli matrices,
\nomenclature[1σ04]{$\v{\sigma}$}{Pauli
    vector, composed of the three Pauli matrices: $\v{\sigma}=(\sigma_x,\sigma_y,\sigma_z)$}%
\index{Pauli vector}%
\index{Pauli matrix}%
the interaction can be written
\begin{equation}
   V_\text{magn} = -\v{\mu}\v{B} = + \mu\PauliVec\v{B}.
\end{equation}
The final expression has a plus sign because the magnetic moment of the neutron
is antiparallel to its spin,
as expressed by the gyromagnetic ratio $-1.91$.
We introduce the reduced field
\begin{equation}
  \v{b} \coloneqq \frac{2m\mu}{\hbar^2}\v{B},
\end{equation}
\nomenclature[2h050 2r040]{$\v{b}(\r)$}{Rescaled field $\v{b}=(m\mu/2\pi\hbar^2)\v{B}$}%
\index{Magnetizing field!reduced}%
to write the spin-dependent Schrödinger equation as
\index{Schrodinger@Schrödinger equation}%
\begin{equation}\label{ESchrodi2H}
  \left[\Nabla^2+K^2-v(\r)-\v{b}(\r)\PauliVec\right] \v\Psi(\r) = 0.
\end{equation}
\index{Neutron!spin|)}%
\index{Spin|)}%
\index{Magnetic field!neutron propagation|)}%

\index{Wave propagation!neutron|)}%
\index{Neutron!wave propagation|)}%

%===============================================================================
\subsection{X-rays}\label{SXwave}
%===============================================================================

\index{Wave propagation!X-ray|(}%
\index{X-ray!wave propagation|(}%

The propagation of X-rays is governed by Maxwell's equations.
We shall use SI units throughout:
\index{Maxwell's equations}%
\begin{equation}\label{EMaxwell}
  \begin{array}{@{}l@{\quad}l@{\quad}l}
    \Nabla\times\v{E}=-\partial_t \v{B},
   &\Nabla\v{B}=0,
   &\v{B}=\v{\mu}(\r)\mu_0\v{H},
   \\[2ex]
    \Nabla\times\v{H}=+\partial_t \v{D},
   &\Nabla\v{D}=0,
   &\v{D}=\v{\eps}(\r)\eps_0\v{E}.
  \end{array}
\end{equation}
\nomenclature[2e150 2r040 2t020]{$\v{E}(\r,t)$}{Electric field}%
\index{Electric field}%
\nomenclature[2d150 2r040 2t020]{$\v{D}(\r,t)$}{Displacement field}%
\nomenclature[2b150 2r040 2t020]{$\v{B}(\r,t)$}{Magnetic field}%
\index{Magnetic field}%
\index{Magnetizing field}%
\nomenclature[1ε070 2r040]{$\v\eps(\r)$}{Relative dielectric permittivity tensor}%
\nomenclature[1μ070 2r040]{$\v\mu(\r)$}{Relative magnetic permeability tensor}%
\nomenclature[1ε024 00]{$\eps_0$}{Vacuum permittivity, 8.854\ldots As/Vm}%
Since BornAgain only addresses elastic scattering,
\index{Elastic scattering}%
\index{Scattering!elastic}%
we assume the permeability and permittivity tensors $\v\mu$ and~$\v\eps$
to be time-independent.
\index{Time dependence!dielectric permittivity}%
Therefore we only consider monochromatic waves
\index{Wave!monochromatic}%
\index{Monochromatic wave}%
with given frequency~$\omega$,
\begin{equation}\label{EstationaryX}
  \v{E}(\r,t) = \v{E}(\r)\e^{-i\omega t},
\end{equation}
and similarly for the other fields $\v{D}$, $\v{H}$, $\v{B}$.
The minus sign in the exponent has been chosen
for consistency with the neutron case \cref{Estationarywave},
where it is an inevitable consequence
of the standard form of the Schrödinger equation.
\index{Sign convention!wave propagation|(}%
Opposite to this \E{quantum-mechanical convention},
there exists a \E{crystallographic convention},
which is preferred in most texts on X-ray crystallography,
including influential texts on GISAXS \cite{ReLL09}.

Since magnetic refraction or scattering is beyond the scope of BornAgain,
the relative magnetic permeability tensor is always $\v{\mu}(\r)=1$.
\index{Permeability}%
\index{Magnetic permeability}%
As customary in SAXS and GISAXS,
\index{Grazing-incidence small-angle scattering!dielectric model}%
\index{Small-angle scattering!dielectric model}%
we assume
that the dielectric properties of the material are those of a polarizable electron cloud.
This is occasionally called the \E{Laue model}
\index{Laue model}%
\cite{Lau31}.
Thereby the relative dielectric permittivity tensor~$\v{\eps}$
\index{Dielectric permittivity}%
\index{Permittivity}%
becomes a scalar,
\begin{equation}
  \eps(\r)=1-\frac{4\pi r_e}{K^2}\rho(\r),
\end{equation}
\nomenclature[1ε030 2r040]{$\eps(\r)$}{Relative dielectric permittivity function}%
\nomenclature[1ρ030 2r040]{$\rho(\r)$}{Electron number density}%
with the classical electron radius~$r_e=e^2/(4\pi\epsilon_0 mc^2)\simeq2.8\cdot10^{-15}$~m,
\index{Electron radius}%
\index{Classical electron radius}%
\nomenclature[2r024 2e000]{$r_e$}{Classical electron radius~$2.817\ldots^{-15}$~m}%
the electron number density~$\rho(\r)$,
\index{Electron density}%
\index{Density!electron}%
\index{Number density|see{Density}}%
and the vacuum wavenumber~$K$,
given by the dispersion relation
\begin{equation}
  K^2 = \mu_0\eps_0\omega^2 = \omega^2/c^2.
\end{equation}
\index{Dispersion!X-ray}%
With these simplifying assumptions about $\v{\eps}$ and~$\v{\mu}$,
Maxwell's equations yield the wave equation
\begin{equation}\label{ENabCrossNabE}
  \Nabla\times\Nabla\times\v{E} = K^2\eps(\r)\v{E}.
\end{equation}
\index{Wave equation!X-ray}%
\index{X-ray!wave equation}%
Using a standard identity from vector analysis, it can be brought into the more tractable form
\begin{equation}\label{ENabNabE}
  \left[\Nabla^2-\Nabla\otimes\Nabla+ K^2\eps(\r)\right]\v{E}(\r)=0.
\end{equation}

\index{Wave propagation!X-ray|)}%
\index{X-ray!wave propagation|)}%

%===============================================================================
\subsection{Unified wave equation}\label{SuniWave}
%===============================================================================

We combine all the above in a unified wave equation
\index{Wave equation!generic}%
\begin{equation}\label{EWAVE}
  \left[ \TDo - \TV(\r) \right] \v\Psi(\r) = 0
\end{equation}
with the vacuum wave operator
\index{Vacuum!wave operator}%
\index{Wave!operator!vacuum}%
\begin{equation}\label{EDo}
  \TDo \coloneqq \left\{ \begin{array}{ll}
      \Nabla^2 + K^2                     &\text{~~~for neutrons,}\\
      \Nabla^2 - \Nabla\otimes\Nabla + K^2 &\text{~~~for X-rays}
  \end{array}\right.
\end{equation}
\nomenclature[2d138 0 2r040]{$\TDo(\r)$}{Differential operator in the vacuum wave equation}%
and the potential
\index{Potential!generic}%
\nomenclature[2v170 2r040]{$\TV(\r)$}{Generic potential}%
\begin{equation}\label{ETV}
  \TV(\r) \coloneqq \left\{ \begin{array}{ll}
      v(\r)                       &\text{~~~for neutrons (scalar),}\\
      v(\r)+\v{b}(\r)\PauliVec    &\text{~~~for neutrons (spinorial),}\\
      K^2(\epsilon(\r)-1)         &\text{~~~for X-rays.}
  \end{array}\right.
\end{equation}
The generic wave amplitude $\v{\Psi}$
\nomenclature[1ψ150 2r040]{$\v\Psi(\r)$}{Generic wave amplitude,
  possibly vectorial or spinorial}%
shall represent
the scalar neutron wavefunction~$\psi$,
the spinor $\v{\Psi}$, or the electric vector field~$\v{E}$, as applicable.

%===============================================================================
\subsection{Density operator, flux}\label{SdensityMatrix}
%===============================================================================

An eigenfunction of the vacuum wave operator~$\TDo$ is a plane wave
with real wavevector~$\k$.
\nomenclature[2k040]{$\k$}{Wavevector}%
In the spinor or vector case, its polarization shall be expressed
in an orthonormal base $\{\v{u}_\alpha\}$
with $\alpha=1,2$
(for spin 1/2 or for traverse electric field in vacuum).
The corresponding eigenstate can be written as ket $\ket\ka$,
the real-space coordinate representation as
\begin{equation}
   \v\Psi_\ka(\r)
   \equiv \braket{\r|\ka}
   = {(2\pi)}^{-3/2} \v{u}_\alpha \e^{i\k\r}.
\end{equation}
The incident neutron beam in an actual scattering experiment
is not such a \E{pure} state,
\index{Pure quantum state}%
\index{Quantum state!pure vs mixed}%
but a statistical mixture of states,
\index{Mixed quantum state}%
and must therefore be described by the density operator
\index{Density operator}%
\nomenclature[1ρ020]{$\hat\rho$}{Density operator}%
\begin{equation}\label{EdefRho}
  \v\rho \coloneqq \sum_\ka p_\ka \ket\ka\bra\ka,
\end{equation}
where $p_\ka$ quantifies the contribution of pure state~$\ket\ka$.
\nomenclature[2p022 2j000]{$p_\ka$}{Weight of state~$ket\ka$ in the density operator}%

In quantum mechanics, the current density, or flux, is measured by the operator
\begin{equation}\label{EdefJop}
  \v{J}
  \coloneqq \frac{1}{2}\big[\ket{\r}\bra{\r}\k
                              + \k\ket{\r}\bra{\r} \big].
\end{equation}
\index{Flux!neutron}%
\index{Current density|see{Flux}}%
With \cref{EdefRho}, we obtain
\begin{equation}\label{EJ}
  \v{J}(\r)
  \coloneqq \Tr(\v\rho\v{J})
  = \sum_\ka p_\ka\, \text{Re}(\k)\, {\left|{\v\Psi_\ka}\right|}^2.
\end{equation}
\nomenclature[2j150 2r040]{$\v{J}(\r)$}{Flux}%
In the electromagnetic case, the energy flux is given by the Poynting vector,
\index{Poynting vector}%
\index{X-ray!flux}%
\index{Flux!X-rays}%
which for complex fields takes the form
\begin{equation}
  \v{S}\coloneqq \Re(\v E(\r,t))\times\Re(\v H(\r,t)).
\end{equation}
\nomenclature[2s150]{$\v S$}{Poyinting vector}%
For a stationary plane wave $\v E(\r)=\v E_\k \e^{i\k\r}$ in vacuum,
we find
\begin{equation}
  S = \frac{1}{2\omega\mu_0} |\v E_\k|^2 \Re \k,
\end{equation}
which confirms the common knowledge that the radiation intensity
counted in a detector is proportional to the squared electric field amplitude.
At constant frequency, the prefactor is ignorable
so that we can use the quantum-mechanical flux~\cref{EJ} also for x-rays.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Distorted-wave Born approximation}\label{SDWBA}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To describe scattering from a condensed-matter sample,
\index{Scattering!target|see{Sample}}%
\index{Target|see{Sample}}%
\index{Sample}%
the wave equation is solved through a perturbation expansion.
The ordinary form of this expansion, the \E{Born approximation} (BA),
\index{BA|see{Born approximation}}%
\index{Born approximation}%
describes the scattering of a plane wave.
Under grazing incidence, however,
refraction and reflection can distort an incident plane wave
quite substantially.
This motivates the
\index{Distorted-wave Born approximation}%
\E{distorted-wave Born approximation} (DWBA).\footnote
{The DWBA was originally devised by Massey and Mott (ca 1933)
for collisions of charged particles.
Summaries can be found in some quantum mechanics textbooks (Messiah, Schiff)
and in monographs on scattering theory (e.~g.\ Newton).
The first explicit applications to grazing-incidence scattering
were published in 1982:
Vineyard \cite{Vin82} discussed X-ray scattering,
but failed to account for the distortion of the scattered wave;
Mazur and Mills \cite{MaMi82} deployed heavy formalism
to compute the inelastic neutron scattering cross section
of ferromagnetic surface spin waves from scratch.
A concise derivation of the DWBA cross section
was provided by Dietrich and Wagner (1984/85)
for X-rays \cite{DiWa84} and neutrons \cite{DiWa85}.
Unfortunately, their work was overlooked in much of the later literature,
which often fell back to less convincing derivations.}
In this section, we provide a self-contained derivation
based on the unified neutron and X-ray wave equation~\cref{EWAVE}.

%===============================================================================
\subsection{Distortion versus perturbation}\label{Sdecompose}
%===============================================================================

To get started,
we decompose the potential \cref{ETV}
into a more regular and a more fluctuating part:
\begin{equation}\label{Edecompose}
  \TV(\r) \eqqcolon \TL(\r) + \TU(\r).
\end{equation}
The \E{distortion field}~$\TL$
\index{Distortion field}%
\nomenclature[1λ170 2r040]{$\TL(\r)$}{Distortion field}%
comprises regular, well-known features of the sample.
The \E{perturbation potential}~$\TU$
\index{Perturbation potential}%
\index{Potential!perturbation}%
\nomenclature[2u170 2r040]{$\TU(\r)$}{Perturbation potential}%
stands for the more irregular, unknown features of the sample
one ultimately wants to study in a scattering experiment.
This is vague,
and in certain situations the decomposition~\cref{Edecompose} is indeed
to some extent arbitrary.
In our application context,
$\TL(z)$ is responsible for refractions and reflections
by multilayer structures,
whereas $\TU(\r)$ accounts for all lateral fluctuations.

The distortion field~$\TL$ is combined
with the vacuum wave operator~$\TDo$ \cref{EDo}
into the \E{distorted wave operator}
\index{Distorted wave!operator}%
\index{Wave!operator!distorted}%
\nomenclature[2d138 2r040]{$\TD(\r)$}{Differential operator in the wave equation}%
\begin{equation}
  \TD(\r) \coloneqq \TDo - \TL(\r)
\end{equation}
that governs the unperturbed distorted wave equation
\index{Unperturbed distorted wave equation}%
\index{Distorted wave!wave equation}%
\index{Wave equation!unperturbed distorted}%
\begin{equation}\label{EDPsi0}
  \TD(\r)\v\Phi(\r) = 0.
\end{equation}
The solutions~$\v\Phi$ are the \E{distorted} waves
\index{Distorted wave}%
\index{Wave!distorted}%
that are scattered by the perturbation $\v{U}$,
as developed below in Sect.~\ref{SxDWBA}.

%===============================================================================
\subsection{Refractive index}\label{Sri1}
%===============================================================================

Except for neutrons in a magnetic field
the distortion field is scalar so
that it can be expressed through the \E{refractive index}
\index{Refractive index}%
\index{Index of refraction|see {Refractive index}}%
\nomenclature[2n020]{$n$}{Refractive index}%
\begin{equation}\label{EnkK}
  n(\r)
  \coloneqq\sqrt{1-\frac{4\pi\Lambda(\r)}{K^2}}
  = \left\{\begin{array}{ll}
       \sqrt{1-4\pi\mv(\r)/K^2} &\text{ for neutrons,}\\
       \sqrt{\epsilon(\r)} &\text{ for X-rays.}
    \end{array}\right.
\end{equation}
If $\mv(\r)$ or $\epsilon(\r)$ has an imaginary part, describing absorption,
\index{Absorption}%
then $n(\r)$ is a complex number.
Conventionally, $n$ is parameterized by two real numbers:
\begin{equation}\label{Endb1}
  n \eqqcolon  1-\delta +i\beta.
\end{equation}
\nomenclature[1δ020]{$\delta$}{Small parameter in the refractive index
   $n=1-\delta +i\beta$}%
\nomenclature[1β020]{$\beta$}{Imaginary part of the refractive index}%
\Cref{SRefrIndx} explains how to determine $\delta$ and~$\beta$.

For thermal neutrons and X-rays,
with quantum-mechanical sign convention [\cref{Estationarywave,EstationaryX}],
$\delta$ and $\beta$ are almost always nonnegative,
\index{Refractive index!sign convention}%
\index{Sign convention!refractive index}%
and much smaller than~1.
This explains why in most scattering geometries
\index{Scattering!geometry}%
the ordinary Born approximation
\index{Born approximation}%
with $\TL\equiv0$ is perfectly adequate.
In layered samples under grazing incidence,
\index{Grazing incidence}%
however, even small differences in~$n$ can cause substantial
\E{refraction} and \E{reflection}.
\index{Refraction}%
\index{Reflection}%
To model GISAS, therefore,
it is necessary to use DWBA,
\index{Distorted-wave Born approximation}%
and to let $\TL$ represent
the average vertical refractive index profile~$\overline{n}(z)$.
\index{Refractive index!profile}%

%===============================================================================
\subsection{Scattering cross section in DWBA}\label{SxDWBA}
%===============================================================================

Altogether, we need to consider three different wave equations,
which we write here in function-space notation:
The vacuum wave equation that it solved by plane-wave states,
\begin{equation}\label{EWave1}
  \TDo \ket\ka = 0;
\end{equation}
the unperturbed distorted-wave equation \cref{EDPsi0},
\begin{equation}\label{EWave2}
  \TD\ket{\v\Phi} = 0;
\end{equation}
and the wave equation \cref{EWAVE} of the full, perturbed problem
\begin{equation}\label{EWave3}
  (\TD-\TU)\ket{\v\Psi} = 0.
\end{equation}
To solve~\cref{EWave3},
we first transform it into a Lippmann-Schwinger equation,
\index{Lippmann-Schwinger equation}%
\begin{equation}\label{ELS3}
   \ket{\v\Psi} = \ket{\v\Phi_\si} + \TG\TU\ket{\v\Psi}
\end{equation}
with the Green function
\index{Green function}%
\nomenclature[2g170 2r020 2r021]{$\TG(\r,\r')$}{Generic (possibly tensorial) Green function}%
\begin{equation}\label{EdefG}
   \TG \coloneqq \TD^{-1}
\end{equation}
and with the incident distorted wave~$\ket{\v\Phi_\si}$.
To see that the left-hand side of~\cref{ELS3}
solves indeed the wave equation~\cref{EWave3},
operate from the left with~$\TD$ on both sides of~\cref{ELS3}.

The Lippmann-Schwinger equation can be resolved by iterative substitution
into an infinite series,
\begin{equation}\label{EBornSeries}
  \ket{\v\Psi}
  = \ket{\v\Phi_\si}
  + \TG\TU \ket{\v\Phi_\si}
  + \TG\TU \TG\TU  \ket{\v\Phi_\si}
 + \ldots
\end{equation}
\index{Perturbation expansion}%
\index{Born!expansion (or series)}%
This is the \E{Born expansion} or \E{Born series}.\footnote
{Named after Max Born who introduced it in quantum mechanics.
It is actually due to Lord Rayleigh who devised it for sound,
and later also applied it to electromagnetic waves,
which resulted in his famous explanation of the blue sky.}
As long as $\TU$ is a small perturbation, the series converges quickly.
In \E{first-order Born approximation},
\index{Born approximation}%
only the linear order in $\TU$ is retained,
\begin{equation}\label{EBorn1}
  \ket{\v\Psi}
  = (1 + \TG\TU) \ket{\v\Phi_\si}.
\end{equation}
In scattering experiments we are only interested in the scattered
wave at positions $\r$ that are far away from the sample ($r\to\infty$)
and that are not illuminated by the distorted (refracted or reflected) incident beam,
\index{Scattered radiation!Born approximation}%
\index{Wave!scattered}%
\begin{equation}\label{EBornS}
  \ket{\v\Psi^\infty_\text{s}}
  \coloneqq \TG^\infty\TU\ket{\v\Phi_\si}.
\end{equation}
\nomenclature[1ψ034 2s000 0 2r040]{$\psi_\text{s}(\r)$}{Scattered wavefunction}%
\nomenclature[2s000 0]{s}{Subscript ``scattered''}%
This is the base for material investigations with X-rays or neutrons,
where sample structures that modulate the perturbation potential $\TU$
are deduced from the differential scattering cross section
\index{Cross section}%
\index{Scattering!cross section}%
\index{Incident radiation!flux|(}%
\index{Scattered radiation!flux}%
\index{Born approximation!elastic scattering cross section}%
\index{Distorted-wave Born approximation!elastic cross section}%
\begin{equation}\label{Exsectiondef}
  \xElas
  \coloneqq  \frac{r^2 J_\sf(\r)}{J_\si}
  = r^2 {|\v\Psi^\infty_\text{s}(\r)|}^2,
\end{equation}
\nomenclature[1ω120]{$\Omega$}{Solid angle}%
\nomenclature[1σ020]{$\sigma$}{Scattering or absorption cross section}%
assuming that the incident wave $\v\Phi_\si$, excited
by a plane wave $\ket{\v\Phi^\infty_\si}=\ket{\k_\se\alpha_\se}$,
is normalized to unity, ${|\v\Phi^\infty_\si|}^2=1$.

%===============================================================================
\subsection{The DWBA far-field Green function}\label{SDWGreen}
%===============================================================================

From \cref{SxDWBA}, the task is left over
to determine the far-field Green function~$\TG^\infty$.
Assume we know the Green function of the undistorted wave equation~\cref{EWave1},
$\TGo\coloneqq\TDo^{-1}$.
Write the distorted wave equation~\cref{EWave2}
as a Lippmann-Schwinger equation
\begin{equation}\label{ELS2}
  \ket{\v\Phi}
  = \ket\ka + \TGo\TU\ket{\v\Phi}.
\end{equation}
To verify, operate with $\TDo$ from the left.
Solve formally through simple algebraic manipulations,
\begin{equation}\label{EPhi}
  \ket{\v\Phi} = {(\v1-\TGo\TU)}^{-1}\ket\ka \eqqcolon \TR\ket\ka.
\end{equation}
Following Dietrich and Wagner \cite{DiWa84,DiWa85,DiWa16},
we note that the distorted-wave Green function~\cref{EdefG}
also obeys a Lippmann-Schwinger equation,
\begin{equation}
   \TG = \TGo + \TGo\TU\TG.
\end{equation}
To verify, operate again with $\TDo$ from the left.
Resolve algebraically for
\begin{equation}
  \TG  = {(\v1-\TGo\TU)}^{-1} \TGo \eqqcolon \TR\TGo.
\end{equation}
To make use of~\cref{EPhi},
we insert a complete projector,
\begin{equation}
  \TG  = \sum_\alpha \int\!\d^3k\,\TR\ket\ka\bra{\ka}\TGo
       = \sum_\alpha \int\!\d^3k\,\ket{\v\Phi_\ka}\bra{\ka}\TGo
\end{equation}
where the dependence of $\v\Phi$ on the boundary condition~$\ka$ is explicitly denoted.
As $\TGo$ is known in real-space representation, we insert another projector,
\begin{equation}
  \TG  = \sum_\alpha \int\!\d^3k\int\!\d^3r''\, \ket{\v\Phi_\ka}\braket{\ka|\r''}\bra{r''}\TGo.
\end{equation}
In real-space coordinates,
\begin{equation}\label{EGrspace}
  \TG(\r,\r')
  = (2\pi)^{-3} \sum_\alpha \int\!\d^3k\int\!\d^3r''\,
        \v\Phi_\ka(\r)\otimes \hu_\alpha \e^{-i\k\r''} \TGo(\r'',\r').
\end{equation}
At this point, we need the vacuum Green function~$\TGo$.
In the scalar case, for an outgoing wave, it is
\begin{equation}\label{EGo1}
  G_0(\r,\r') = \frac{\e^{iK|\r-\r'|}}{4\pi|\r-\r'|}
  \eqqcolon g(|\r-\r'|).
\end{equation}
for polarized neutrons,
\begin{equation}\label{EGo2}
  \TGo(\r,\r') = \v1 G_0(\r,\r');
\end{equation}
for X-rays\footnote{Eqn.~B5 of \cite{DiWa84} has a sign error.}
\begin{equation}\label{EGo3}
  \TGo(\r,\r') = (\v1 -K^{-2}\Nabla\otimes\Nabla) G_0(\r,\r').
\end{equation}
The far-field limit is usually considered in the first argument,
\begin{equation}\label{EGinftydef}
  \TGo^\infty(\r,\r')\coloneqq \lim_{r\to\infty} \TGo(\r,\r'),
\end{equation}
but it is easily seen from \cref{EGo1,EGo2,EGo3} that
\begin{equation}\label{EGoReci}
  \TGo(\r,\r')=\TGo(\r',\r),
\end{equation}
as expected from more general reciprocity theorems \cite{Pot04}.

We expand for $\r'$ with $r'\ll r$:
\begin{equation}
  \left|\r-\r'\right|
  \doteq \sqrt{r^2-2\r\,\r'}
  \doteq r - \frac{\r\,\r'}{r}
  \equiv r - \frac{\k_\sf \r'}{K},
\end{equation}
\nomenclature[2f000]{f}{Subscript ``final''}%
where we have introduced the outgoing wavevector
$  \k_\sf\coloneqq K \r / r$.
We apply this to~\cref{EGo1},
\index{Green function!homogeneous material}%
and obtain in leading order the far-field Green function
\begin{equation}\label{EGoFar1}
  G_0^\infty(\r,\r')
  = g(r)\psi^*_\sf(\r'),
\end{equation}
where $g$ is the outgoing spherical wave introduced in \cref{EGo1},
\begin{equation}%\label{EPsisfar}
  \psi_\sf(\r) \coloneqq  \e^{i\k_\sf \r}
\end{equation}
\nomenclature[1ψ034 2f000 2r040]{$\psi_\sf(\r)$}{Plane
  wave propagating from the sample towards the detector}%
is a plane wave propagating towards the detector,
and $\psi^*$ designates the complex conjugate of $\psi$.
The $\Nabla\otimes\Nabla$ term in \cref{EGo3}
is negligible for $Kr\gg1$,
hence
\begin{equation}\label{EGoFar2}
  \TGo^\infty(\r,\r') = \v1 G_0(\r,\r')
\end{equation}
in the polarized neutron as in the X-ray case.
We apply reciprocity \cref{EGoReci}
to \cref{EGoFar2,EGoFar1} and insert the resulting
\begin{equation}
  \TGo^\infty(\r,\r')=\v1\psi^*_\sf(\r)g(r')
\end{equation}
into~\cref{EGrspace} to obtain
\nomenclature[2g174 2far]{$\TG^\infty(\r,\r')$}{Far-field
   approximation to the Green function $G(\r,\r')$}%
\begin{equation}\label{EGresult}
  \lim_{r'\to\infty}\TG(\r,\r')
  = \sum_\alpha \v\Phi_{\k_\sf\alpha}(\r)\otimes \hu_\alpha g(r').
\end{equation}

%--------------------------------------------------------------------------------
\begin{figure}[tb]
\begin{center}
\includegraphics[width=1\textwidth]{fig/drawing/Green1.ps}
\end{center}
\caption{(a)
The Green function $G(\rS,\rD)$
\index{Green function}%
is the probability that radiation emitted
by a source~S is reaches a detector~D.
If S is a locus of scattering in a multilayer sample,
then $G$ is a sum over different trajectories,
\index{Trajectory}
involving refraction and reflection
at layer interfaces.
(b) For the far-field
\index{Far-field approximation!Green function}%
Green function $G^\infty(\rS,\rD)$,
the detector is moved so far away from the sample
that all trajectories are practically parallel when they leave the sample.}
\label{Fgreen1}
\end{figure}
%--------------------------------------------------------------------------------


%===============================================================================
\subsection{Reciprocity of the Green function}\label{SReci}
%===============================================================================

\index{Reciprocity|(}%
\index{Green function!reciprocity|(}%

Our computation of~$G_\infty$ will be based on a source-detector \E{reciprocity theorem}
for the scalar Schrödinger equation.\footnote
{There exists a confusing multitude of reciprocity theorems \cite{Pot04}.
In the end, we found it simpler to provide a derivation taylored for our application case
than to refer to the literature.}
The theorem states:
Any Green function $G(\r,\r')$
that solves~\cref{EGREEN} and as function of~$\r$ represents an outgoing wave
%(in accord with the Sommerfeld radiation condition)
%\index{Sommerfeld radiation condition}%
is invariant under an exchange of source location~$\rS$ and detection point~$\rD$:
\nomenclature[2r041 2d100]{$\rD$}{Position of detector}%
\nomenclature[2r041 2s100]{$\rD$}{Position of source, locus of scattering}%
\begin{equation}\label{Erecip}
  G(\rS,\rD) = G(\rD,\rS).
\end{equation}
Readers not interested in mathematical details may skip the following \E{proof}:

We introduce the auxiliary vector field
\begin{equation}
  \v{X}(\r,\rS,\rD)\coloneqq G(\r,\rD)\Nabla G(\r,\rS) - G(\r,\rS)\Nabla G(\r,\rD).
\end{equation}
%\nomenclature[2x150 2r040]{$\v{X}(\r,\rS,\rD)$}{Auxiliary vector field}%
We inscribe the sample and the detector
into a sphere $\Sphere$ around the coordinate origin with radius~$R$,
%\nomenclature[2s180]{$\Sphere$}{Auxiliary spherical volume}%
%\nomenclature[2r120]{$R$}{Radius of $\Sphere$}%
and compute the volume integral
\begin{equation}\label{Eprerecipro}
    I(\rS,\rD) \coloneqq \displaystyle\int_\Sphere\!\d^3r\,\Nabla \v{X}(\r,\rS,\rD).
\end{equation}
After a few steps, not entirely trivial, but not too difficult either,
we obtain
\begin{equation}\label{EIBD}
  I(\rS,\rD) = G(\rS,\rD) - G(\rD,\rS).
\end{equation}
Alternatively, we can compute $I$ as a surface integral
\begin{equation}
  I(\rS,\rD)
  =\displaystyle\int_{\partial\Sphere}\d\v{\sigma}\,\v{X}(\r,\rS,\rD).
\end{equation}
On the surface $\partial\Sphere$,
$G$ is an outgoing solution of the Helmholtz equation.
As such, it has a well-known series expansion in spherical coordinates.
We send $R\to\infty$ so that we need only to retain the lowest order:
\begin{align}
   G(\r(R,\vartheta,\varphi),\rD)
   &\doteq\displaystyle \frac{\e^{iKR}}{4\pi R} a(\vartheta,\varphi),
   \\[3.8ex]
   G(\r(R,\vartheta,\varphi),\rS)
   &\doteq\displaystyle \frac{\e^{iKR}}{4\pi R} b(\vartheta,\varphi).
\end{align}
The factorization of $G$ and $B$ and their common $R$ dependence imply that
\begin{equation}
  I(\rS,\rD)
  =\displaystyle\int_{\partial\Sphere}\d\sigma\,
       (\text{$R$-dependent})(ab-ba)
  = 0.
\end{equation}
Comparison with \cref{EIBD} yields \cref{Erecip},
which completes the proof.

\index{Reciprocity|)}%
\index{Green function!reciprocity|)}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{OLD STUFF}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%===============================================================================
\subsection*{exciting vs incident wave}
%===============================================================================

The solution of the wave equation~\cref{EDPsi}
starts with the determination of the incident wave~$\v\Psi_\si$.
\nomenclature[1ψ074 2i000 2r040]{$\v\Psi_\si(\r)$}{Incident wavefunction}%
\nomenclature[2i000]{i}{Subscript ``incident''}%
\index{Incident radiation!Born approximation}%
\index{Wave!incident}%
\index{Radiation|seealso{Wave}}%
\index{Incident wave!DWBA}%
\index{Incident wave!vs exciting wave}%
It is important to distinguish the \E{incident} from the \E{exciting} wave.
\index{Exciting wave}%
\index{Wave!exciting}%
They coincide in ordinary Born approximation, but not in DWBA.
\index{Born approximation}%,

The \E{exciting wave}
is prepared far
outside the sample by a radiation source and some optical devices.
\index{Radiation source}%
It is a superposition of plane waves,
as discussed later in the context of instrumental resolution effects
(\cref{SInstr}).
Here we will consider a single plane wave
$\v\Psi_\se(\r)=\hu_\se\e^{i\k_\se\r}$.
\nomenclature[1ψ134 2e000]{$\v\Psi_\se(\r)$}{Exciting wave}%
This function is defined for all~$\r$,
but is physical only along the primary beam, upstream of the sample.

The \E{incident wave}~$\v\Psi_\si$
\index{Incident wave!DWBA}%
\index{Incident wave!vs exciting wave}%
\index{Wave!incident}%
is an exact solution of~\cref{EDPsi0}
under the boundary condition that it match~$\v\Psi_\se$
upstream of the sample.
Inside the sample it undergoes refraction and reflection
or other modifications under the influence of the distortion field~$\TL$.

%===============================================================================
\subsection*{Scattering vector $\v{q}$}
%===============================================================================

 the \E{scattering vector}\footnote
{With this choice of sign,
\index{Sign convention!scattering vector}%
$\hbar\q$ is the momentum
\index{Momentum transfer|see {Scattering vector}}%
\E{gained} by the scattered neutron,
and \E{lost} by the sample.
In much of the literature the opposite convention is prefered,
since it emphasizes the sample physics over the scattering experiment.
However, when working with two-dimensional detectors
it is highly desirable to express pixel coordinates
\index{Coordinate system}
\index{Detector!pixel coordinate}
and scattering vector components
with respect to equally oriented coordinate axes,
which can only be achieved by the convention~\cref{Eq}.}
\index{Scattering!vector}%
\begin{equation}\label{Eq}
  \q\coloneqq \k_\sf-\k_\si.
\end{equation}
\nomenclature[2q040]{$\q$}{Scattering vector}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coherent vs incoherent scattering}\label{Scoherlen}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%===============================================================================
\subsection{Coherence length}
%===============================================================================

Per \cref{Exsection} and~\cref{Etrama},
\index{Coherence length|(}%
the matrix element $\braket{\psi_\si|\delta v|\psi_\sf}$
is given by a three-dimensional integral
\begin{equation}\label{Etrama3}
  \braket{\psi_\si|\delta v|\psi_\sf}
  \coloneqq  \int\!\d^3r\, \psi^{*}_\si(\r)\delta v(\r)\psi_\sf(\r).
\end{equation}
The integration domain is effectively limited to a finite $z$ interval,
where $\delta v(\r)$ is nonzero.
The horizontal integration domain, however, is infinite
within our formalism,
which is of course an idealization.
Obviously, physical integration limits are imposed by the finite
\index{Sample area}%
\E{illuminated sample area}.\footnote
{We assume a well aligned instrument,
for which the beam footprint and the backtracked detector footprint
\index{Illumination!beam footprint on sample}%
\index{Beam footprint}%
\index{Backtracking!beam footprint}%
agree within reasonable accuracy.}
Another limitation comes from the finite \E{coherence length}
of the instrumental setup,
which usually is much shorter than the sample width and length
%This is of importance in neutron scattering
%where typical sample dimensions of 1\ldots10~mm
%are much larger than the relevant coherence length,
%which is of the order 10\ldots100~$\upmu$m
\cite{HaPR10,MaMM14}.\footnote
{These two references also make clear that
  the theoretical description and the experimental determination of
  coherence lengths are difficult problems and subject of ongoing research.}

While each single neutron is described by a wavefunction
that allows for \E{coherent} superposition of
different contributions to the scattered wavefunction,
the final detector statistics
\index{Detector!statistics}%
is given by an \E{incoherent} sum
over the differential cross sections of individual neutrons.
The finite \E{resolution}
\index{Resolution|(}%
of an experimental setup is in part due to the fact that
different neutrons have different wavenumbers,
originate\footnote
{It is reasonable to take the last collision in the moderator
  as the \E{origin} of a neutron ray,
  since collisions between neutrons and hydrogen nuclei bound in
  disordered matter lead to almost perfect decoherence.}
at different points in the moderator,
and are detected at slightly different points within one detector pixel.
This can be modeled by computing expected scattering intensities as
averages over different neutrons with
$K$, $\v{\hat k}_\si$, and $\v{\hat k}_\sf$ drawn at random
from appropriate distributions.
% TODO RESTORE TEMPORARILY REMOVED XREF as described in \cref{Sresolution}.

However, this is not the full story.
In the above introduction to the Born approximation
we have made the standard assumption
that an incoming neutron can be described by a plane wave
$\psi_\si=\e^{i\k_\si\r}$.
The wavefunction $\psi_\sf$ traced back from the detector is also
approximated by a plane wave.
In the DWBA we allow these waves to be distorted within the sample,
but when impinging on the sample they still are plane.
A plane wave obviously is an idealized concept,
since it has infinite lateral extension.
The \E{transverse coherence length} indicates the scale
beyond which this approximation becomes invalid.
At larger scales, the wave fronts appear randomly distorted.
Physical causes of these distortions include
reflections in the neutron guide,
diffraction by guide windows and other slits,
and diffraction by imperfect monochromator crystals.
Of course the distorted wave still admits a Fourier decomposition
into plane waves with slightly different wavevectors.
In practice, it is impossible to distinguish this spread of wavevectors
from the incoherent spread described in the previous paragraph.
The instrumental resolution function therefore
accounts for both causes of wavevector distortion.
\index{Resolution|)}%

Usually, therefore, a GISANS image is an incoherent average
over coherent diffraction patterns collected from
many small subareas of the sample.
Only horizontal sample structures on scales smaller the coherence length
yield interference patterns.
Structure fluctuations on larger scales
produce said incoherent average of different GISANS images.

The crossover from coherent to incoherent scattering is of course
a gradual one.
The coherence length indicates where a certain, somewhat arbitrary degree
of decoherence is reached.
Under these reservations
one defines a \E{coherence spot}
in the cross section of an approximately plane wave
as an area where the coherence is above a certain threshold.
Unless the wave has been prepared in a highly anisotropic guide and slit system,
this spot is about circular.
Under grazing incidence conditions however,
the projection of this spot onto the sample surface
yields a very elongated ellipse.
Therefore, the coherence length is much larger in $x$ than
in $y$ or $z$ direction.\footnote
{This has nothing to do with the distinction of
  \E{transverse} and \E{longitudinal} coherence length.
  Longitudinal coherence has to do with wavelength stability
  and is of no importance for elastic scattering.
  We are talking here about \E{horizontal} and \E{vertical}
  projections of the \E{transverse} coherence length.}

%===============================================================================
\subsection{Implementation}
%===============================================================================


\Note{\indent Unless otherwise said, \BornAgain\ simulates
  \E{coherent} diffraction patterns obtained by
  the linear superposition of scattered waves.
  To simulate an \E{incoherent} mixture of diffraction patterns,
  the most generic solution is a script with an outer loop
  that averages over several coherent computations with
  appropriately distributed parameters.}

\Warn{\indent Currently, \BornAgain\ does not support interferences
  between particles in different layers.}
% TODO: more about implementation !

\index{Coherence length|)}%
